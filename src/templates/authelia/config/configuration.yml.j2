#jinja2:lstrip_blocks: True
{%- macro make_secret(name) -%}
  {{ (pinanas.master_secret + name) | password_hash('sha256', pinanas.domain) | b64encode }}
{%- endmacro %}
---
#
## network
#
server:
  host: 0.0.0.0
  port: 9091

default_redirection_url: "https://apps.{{ pinanas.domain }}/"

#
## system
#
log:
  level: debug

server:
  read_buffer_size: 4096
  write_buffer_size: 4096
  path: ""

#
## userland
#
theme: dark

#
## security
#
access_control:
  default_policy: deny
  rules:
    #
    ## === ADMIN SERVICES ===
    #

    # DNS / Ad filter: AdGuardHome
    - domain: "adguardhome-dashboard.{{ pinanas.domain }}"
      policy: two_factor
      subject:
      - "group:admins"

    # Resource monitor: Netdata
    - domain: "resources.{{ pinanas.domain }}"
      policy: one_factor
      subject:
      - "group:admins"

    #
    ## === USER SERVICES ===
    #
    # Application dashboard: Heimdall
    - domain: "apps.{{ pinanas.domain }}"
      policy: one_factor
      subject:
      - "group:users"

    # Cloud: Nextcloud
    - domain: "cloud.{{ pinanas.domain }}"
      policy: bypass

    # Web IDE: VS Code
    - domain: "code.{{ pinanas.domain }}"
      policy: two_factor
      subject:
      - "group:users"

    #
    ## === EXTERNAL SERVICES ===
    #
    {% for service in pianans.services %}
    - domain: "{{ service.name }}.{{ pinanas.domain }}"
      policy: "{{ service.policy | default('two_factor') }}"
      subject:
      - "group:{{ service.group | default('admins') }}"
    {% endfor %}

jwt_secret: "{{ make_secret('jwt_secret') }}"

totp:
  issuer: authelia.com
  period: 30
  skew: 1

authentication_backend:
  disable_reset_password: false
  refresh_interval: 5m
  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
      iterations: 1
      key_length: 32
      salt_length: 16
      memory: 64
      parallelism: 8

session:
  name: authelia_session
  domain: {{ pinanas.domain }}
  same_site: lax
  secret: "{{ make_secret('session.secret') }}"
  expiration: 2h
  inactivity: 15m
  remember_me_duration: 1M

regulation:
  max_retries: 5
  find_time: 2m
  ban_time: 5m

storage:
  encryption_key: "{{ make_secret('storage.encryption_key') }}"
  local:
    path: /config/db.sqlite3

notifier:
  disable_startup_check: true
  smtp:
    username: "{{ pinanas.network.smtp.username }}"
    password: "{{ pinanas.network.smtp.password }}"
    sender: "{{ pinanas.network.smtp.sender }}"
    host: "{{ pinanas.network.smtp.host }}"
    port: "{{ pinanas.network.smtp.port }}"

identity_providers:
  oidc:
    hmac_secret: "{{ make_secret('identity_providers.oidc.hmac_secret') }}"
    issuer_private_key: |
      {{ 'indent=6' | authelia_sshkey }}
    access_token_lifespan: 1h
    authorize_code_lifespan: 1m
    id_token_lifespan: 1h
    refresh_token_lifespan: 90m
    enable_client_debug_messages: false
    clients:
      - id: nextcloud
        description: Nextcloud
        secret: "{{ make_secret('identity_providers.oidc.clients[nextcloud].secret') }}"
        public: false
        authorization_policy: one_factor
        audience: []
        scopes:
          - openid
          - groups
          - email
          - profile
        redirect_uris:
          - "https://cloud.{{ pinanas.domain }}/apps/user_oidc/code"
        grant_types:
          - refresh_token
          - authorization_code
        response_types:
          - code
        response_modes:
          - form_post
          - query
          - fragment
        userinfo_signing_algorithm: none
