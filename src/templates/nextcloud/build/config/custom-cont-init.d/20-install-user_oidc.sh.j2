{%- import 'secrets.j2' as secrets with context -%}
#!/bin/bash

[[ -f /config/installed ]] && exit

function occ () {
    sudo -u  "#${PUID}" /config/www/nextcloud/occ "$@"
}

function is_nextcloud_installed () {
  php -r '
    $configfile = "/config/www/nextcloud/config/config.php";
    file_exists($configfile) or exit(1);
    require($configfile);
    exit(isset($CONFIG["installed"]) && $CONFIG["installed"] ? 0 : 1);
  '
}

function install_user_oidc () {
  while ! is_nextcloud_installed ; do
    echo "*** Nextcloud not yet installed, deferring... ***"
    sleep 15
  done

  echo "*** Installing Nextcloud user_oidc application ***"
  occ app:install user_oidc

  echo "*** Configuring Nextcloud user_oidc application ***"
  occ user_oidc:provider Authelia \
    --clientid="nextcloud" \
    --clientsecret="{{ secrets.make_secret('pinanas.authelia.identity_providers.oidc.clients[nextcloud].secret')[:16] }}" \
    --discoveryuri="https://auth.{{ pinanas.domain }}/.well-known/openid-configuration" \
    --scope="openid groups email profile" \
    --unique-uid=0 \
    --no-interaction

  echo "*** Nextcloud user_oidc application ready ***"
}

(install_user_oidc) &
